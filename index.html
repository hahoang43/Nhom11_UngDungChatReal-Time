<!DOCTYPE html>
<html lang="vi">

<head>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Real-time</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --info: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.7);
            --glass-strong: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #a5b4fc 0%, #c4b5fd 50%, #fbcfe8 100%);
            height: 100vh;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            color: var(--dark);
            overflow: hidden;
        }

        /* Ambient Background shapes */
        .shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
        }

        .shape-1 {
            background: var(--primary);
            width: 400px;
            height: 400px;
            top: -100px;
            left: -100px;
        }

        .shape-2 {
            background: var(--secondary);
            width: 300px;
            height: 300px;
            bottom: -50px;
            right: -50px;
        }

        .shape-3 {
            background: var(--info);
            width: 250px;
            height: 250px;
            top: 40%;
            left: 60%;
        }

        /* Auth Container */
        .auth-container {
            width: 100%;
            max-width: 420px;
            background: var(--glass-strong);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 40px;
            text-align: center;
            z-index: 10;
            transition: all 0.4s ease;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .auth-title {
            color: var(--dark);
            font-size: 1.5rem;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        /* Chat Container - Flex Layout */
        .chat-container {
            width: 95vw;
            max-width: 1200px;
            height: 90vh;
            /* Ch·ªânh l·∫°i ch√∫t cho c√¢n ƒë·ªëi */
            background: var(--glass-strong);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            display: none;
            /* Flex when active */
            box-shadow: var(--shadow);
            overflow: hidden;
            z-index: 10;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(248, 250, 252, 0.6);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .section-title {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin: 20px 0 10px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-icon-small {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
            border-radius: 4px;
            transition: bg 0.2s;
        }

        .btn-icon-small:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .list-item {
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.5);
            margin-bottom: 4px;
        }

        .list-item:hover {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transform: translateY(-1px);
        }

        .list-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .list-item.active .status-dot {
            background: #4ade80;
            border-color: var(--primary);
        }

        .list-item.active .item-actions button {
            color: white;
            opacity: 0.9;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-join {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .btn-join:hover {
            background: var(--success);
            color: white;
        }

        .btn-leave {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            visibility: hidden;
        }

        .list-item:hover .btn-leave {
            visibility: visible;
        }

        .btn-leave:hover {
            background: var(--danger);
            color: white;
        }

        /* --- CHAT MAIN AREA (FLEX ROW) --- */
        .chat-main {
            flex: 1 1 0%;
            background: rgba(255, 255, 255, 0.4);
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: row;
            /* Main layout is row */
            overflow: hidden;
            /* Prevent overflow */
        }

        /* V√πng chat ch√≠nh (gi·ªØa) */
        .chat-primary-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0;
            /* Important for flex items to shrink */
            transition: all 0.3s ease;
            /* Smooth resize */
        }

        /* V√πng th√¥ng tin b√™n ph·∫£i (Members) */
        .chat-info-sidebar {
            width: 0;
            /* Default hidden width */
            background: rgba(255, 255, 255, 0.8);
            border-left: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Hide content when width is 0 */
            transition: width 0.3s ease;
            /* Smooth width transition */
            opacity: 0;
            backdrop-filter: blur(10px);
        }

        .chat-info-sidebar.active {
            width: 300px;
            /* Expanded width */
            opacity: 1;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
        }

        .info-header {
            padding: 20px;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            /* Prevent text wrap during anim */
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            /* width: 300px; - Removed fixed width to allow flex sizing if needed */
        }

        /* Accordion Styles */
        .accordion-header {
            padding: 15px 20px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #334155;
            transition: background 0.2s;
            user-select: none;
        }

        .accordion-header:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .accordion-content {
            display: none;
            /* Hidden by default or toggled */
            padding: 10px;
            background: rgba(0, 0, 0, 0.02);
        }

        .accordion-content.open {
            display: block;
        }

        .accordion-arrow {
            transition: transform 0.3s ease;
        }



        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.5);
            transition: background 0.2s;
        }

        .member-item:hover {
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .member-item .avatar {
            width: 32px;
            height: 32px;
            font-size: 0.85rem;
        }

        .member-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: #334155;
        }

        .member-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e1;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #e2e8f0;
        }

        .member-status.online {
            background: var(--success);
            box-shadow: 0 0 0 1px var(--success);
        }

        /* Container c·ªßa n·ªôi dung chat */
        #chatMainContent {
            display: flex;
            /* Flex c·ªôt */
            flex-direction: row;
            height: 100%;
            width: 100%;
        }

        .chat-header {
            flex-shrink: 0;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 5;
        }

        .chat-title h2 {
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .chat-subtitle {
            font-size: 0.85rem;
            color: #64748b;
        }

        /* V√πng tin nh·∫Øn: T·ª± gi√£n (flex: 1) v√† scroll */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.received {
            background: white;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        .message.sent {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .message.system {
            align-self: center;
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
            border-radius: 20px;
            font-size: 0.8rem;
            padding: 5px 15px;
            max-width: 90%;
            box-shadow: none;
        }

        .msg-sender {
            font-size: 0.75rem;
            margin-bottom: 4px;
            opacity: 0.7;
            font-weight: 600;
            color: var(--primary);
        }

        .sent .msg-sender {
            color: rgba(255, 255, 255, 0.8);
            text-align: right;
        }

        /* V√πng nh·∫≠p li·ªáu: C·ªë ƒë·ªãnh d∆∞·ªõi ƒë√°y container */
        .input-area {
            flex-shrink: 0;
            padding: 20px 30px;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 15px;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            padding: 12px 18px;
            outline: none;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            /* Hi·ªÉn th·ªã ph√≠a tr√™n input area */
            left: 30px;
            margin-bottom: 10px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .emoji-picker span {
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            text-align: center;
            transition: bg 0.2s;
        }

        .emoji-picker span:hover {
            background: #f1f5f9;
        }

        /* Generic UI */
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transform: translateY(-1px);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.8);
        }

        .input-group input:focus {
            border-color: var(--primary);
            background: white;
        }

        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
        }

        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .hidden {
            display: none !important;
        }

        /* Welcome Screen Styling */
        #welcomeScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #64748b;
            background: white;
            height: 100%;
        }

        #welcomeScreen i {
            font-size: 5rem;
            color: #e2e8f0;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        #welcomeScreen h3 {
            font-size: 1.2rem;
            font-weight: 500;
            color: #475569;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Media Previews */
        .media-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .media-preview:hover {
            transform: scale(1.02);
        }

        /* Toast & Typing */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--dark);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        .typing-indicator {
            font-size: 0.75rem;
            color: #64748b;
            margin-left: 10px;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        .back-btn {
            display: none;
            margin-right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }

        .back-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
            }

            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                max-width: none;
                flex-direction: row;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                z-index: 20;
            }

            .chat-main {
                display: none;
                width: 100%;
                height: 100vh;
                position: absolute;
                top: 0;
                left: 0;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                z-index: 30;
            }

            .mobile-show-chat .sidebar {
                display: none;
            }

            .mobile-show-chat .chat-main {
                display: flex;
            }

            /* Hi·ªán d∆∞·ªõi d·∫°ng Flex */

            .back-btn {
                display: inline-flex !important;
            }

            .input-area {
                padding: 10px 15px;
            }

            .chat-input {
                border-radius: 20px;
            }

            .send-btn {
                width: 40px;
                height: 40px;
                border-radius: 50%;
            }
        }

        .unread-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 12px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-left: auto;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.3s ease;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-actions button:first-child {
            background: #e2e8f0;
            color: #64748b;
        }

        .modal-actions button:last-child {
            background: var(--primary);
            color: white;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #selectFriendsList {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }

        .friend-select-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
        }

        .friend-select-item:last-child {
            border-bottom: none;
        }

        .friend-select-item:hover {
            background: #f8fafc;
        }
    </style>
</head>

<body>
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>

    <div id="authPanel" class="auth-container">
        <div class="logo"><i class="fa-brands fa-rocketchat"></i></div>
        <h2 class="auth-title">Ch√†o m·ª´ng tr·ªü l·∫°i</h2>

        <div class="tabs">
            <button class="tab active" onclick="switchAuth('login')" id="tabLogin">ƒêƒÉng Nh·∫≠p</button>
            <button class="tab" onclick="switchAuth('register')" id="tabRegister">ƒêƒÉng K√Ω</button>
        </div>

        <div id="loginForm">
            <div class="input-group">
                <input type="text" id="loginUser" placeholder="T√™n ƒëƒÉng nh·∫≠p" onkeypress="handleEnter(event, 'LOGIN')">
            </div>
            <div class="input-group">
                <input type="password" id="loginPass" placeholder="M·∫≠t kh·∫©u" onkeypress="handleEnter(event, 'LOGIN')">
            </div>
            <button onclick="handleAuth('LOGIN')" class="btn-primary">
                <i class="fa-solid fa-arrow-right-to-bracket"></i> ƒêƒÉng Nh·∫≠p
            </button>
        </div>

        <div id="registerForm" class="hidden">
            <div class="input-group">
                <input type="text" id="regUser" placeholder="T√™n ƒëƒÉng nh·∫≠p" onkeypress="handleEnter(event, 'REGISTER')">
            </div>
            <div class="input-group">
                <input type="password" id="regPass" placeholder="M·∫≠t kh·∫©u" onkeypress="handleEnter(event, 'REGISTER')">
            </div>
            <div class="input-group">
                <input type="password" id="regConfirm" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
                    onkeypress="handleEnter(event, 'REGISTER')">
            </div>
            <button onclick="handleAuth('REGISTER')" class="btn-primary">
                <i class="fa-solid fa-user-plus"></i> ƒêƒÉng K√Ω
            </button>
        </div>

        <p id="authError" style="color: var(--danger); margin-top: 15px; font-size: 0.85rem; height: 1.2em;"></p>
    </div>

    <div id="chatPanel" class="chat-container">
        <div class="sidebar">
            <div class="user-profile">
                <div class="avatar" id="myAvatar">U</div>
                <div style="flex: 1;">
                    <h3 style="font-size: 1rem" id="myNameDisplay">User</h3>
                    <div
                        style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem; color: var(--success); font-weight: 500;">
                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                        Online
                    </div>
                </div>
                <button class="btn-icon-small" title="ƒê·ªïi t√™n" onclick="promptChangeName()" style="color: var(--info);">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button class="btn-icon-small" title="ƒêƒÉng xu·∫•t" onclick="logout()" style="color: var(--danger);">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>

            <!-- Sidebar Tabs -->
            <div class="tabs" style="margin-bottom: 10px; margin-top: 10px;">
                <button class="tab active" onclick="switchSidebar('chats')" id="tabChats">Tr√≤ chuy·ªán</button>
                <button class="tab" onclick="switchSidebar('discover')" id="tabDiscover">Kh√°m ph√°</button>
            </div>

            <!-- CHATS VIEW (Friends & Groups) -->
            <div id="viewChats" class="list-container">
                <div class="section-title">
                    Nh√≥m
                    <button class="btn-icon-small" title="T·∫°o nh√≥m m·ªõi" onclick="createNewGroup()">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <div id="groupsList"></div>

                <div class="section-title" style="margin-top: 20px;">
                    B·∫°n b√®
                </div>
                <div id="friendsList"></div>
            </div>

            <!-- DISCOVER VIEW (Online Users) -->
            <div id="viewDiscover" class="list-container hidden">
                <div class="section-title">
                    Nh√≥m m·ªõi
                </div>
                <div id="groupsConnectList"></div>

                <div class="section-title" style="margin-top: 20px;">
                    Ng∆∞·ªùi d√πng Online
                </div>
                <div id="usersList"></div>
            </div>

            <!-- Pending Requests (Always visible if any, or put in Discover?) -->
            <div id="pendingSection" class="hidden"
                style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 12px;">
                <div class="section-title" style="margin: 0 0 10px 0;">L·ªùi m·ªùi k·∫øt b·∫°n</div>
                <div id="pendingList"></div>
            </div>

        </div>

        <div class="chat-main" id="chatPanelMain">
            <!-- Welcome Screen (Default) -->
            <div id="welcomeScreen">
                <i class="fa-regular fa-comments"></i>
                <h3>Ch·ªçn m·ªôt ƒëo·∫°n chat ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
            </div>

            <div id="chatMainContent" style="display:none">
                <!-- Primary Chat Area -->
                <div class="chat-primary-area">
                    <div class="chat-header">
                        <button class="back-btn" onclick="backToSidebar()">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <div class="avatar" style="background: var(--info);" id="targetAvatar"></div>
                        <div class="chat-title">
                            <h2 id="targetName"></h2>
                            <div class="chat-subtitle" id="targetStatus"></div>
                        </div>

                        <!-- Actions Container -->
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button id="btnCreateGroupFromChat" class="btn-icon-small hidden" style="font-size: 1.2rem;"
                                title="T·∫°o nh√≥m v·ªõi ng∆∞·ªùi n√†y" onclick="openCreateGroupModal()">
                                <i class="fa-solid fa-users-viewfinder"></i>
                            </button>
                            <button id="btnToggleInfo" class="btn-icon-small hidden" title="Th√¥ng tin h·ªôi tho·∫°i"
                                style="font-size: 1.2rem; background: rgba(0,0,0,0.05);" onclick="toggleChatInfo()">
                                <i class="fa-solid fa-circle-info"></i>
                            </button>
                        </div>

                        <div id="typingIndicator" class="typing-indicator hidden">ƒêang nh·∫≠p...</div>
                    </div>

                    <audio id="notifySound"
                        src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAADA3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3g=="></audio>

                    <div class="messages-area" id="messages">
                        <div class="message system">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Nhom11 Chat Real-time!</div>
                    </div>

                    <div class="input-area">
                        <div id="emojiPicker" class="emoji-picker hidden"></div>
                        <input type="file" id="fileInput" style="display:none" />

                        <button class="btn-icon-small" title="G·ª≠i File" style="font-size: 1.2rem; color: #6366f1;"
                            onclick="document.getElementById('fileInput').click()">
                            <i class="fa-solid fa-paperclip"></i>
                        </button>

                        <button class="btn-icon-small" id="emojiBtn" title="Emoji"
                            style="font-size: 1.2rem; color: #fbbf24;" onclick="toggleEmojiPicker()">
                            <i class="fa-solid fa-face-smile"></i>
                        </button>

                        <input type="text" class="chat-input" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..."
                            autocomplete="off">

                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- Right Sidebar (Group Members) -->
                <div class="chat-info-sidebar" id="chatInfoSidebar">
                    <div class="info-header">
                        <span><i class="fa-solid fa-circle-info"></i> Th√¥ng tin h·ªôi tho·∫°i</span>
                        <button class="btn-icon-small" onclick="toggleChatInfo()"><i
                                class="fa-solid fa-xmark"></i></button>
                    </div>

                    <!-- Accordion Item: Members -->
                    <div>
                        <div class="accordion-header" onclick="toggleAccordion('membersAccordion', this)">
                            <span><i class="fa-solid fa-users"></i> Xem th√†nh vi√™n</span>
                            <i class="fa-solid fa-chevron-down accordion-arrow"></i>
                        </div>
                        <div id="membersAccordion" class="accordion-content">
                            <div class="members-list" id="groupMembersList" style="padding:0; min-width:0;">
                                <!-- Members will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="createGroupModal" class="modal hidden">
            <div class="modal-content">
                <h3>T·∫°o nh√≥m v·ªõi b·∫°n b√®</h3>
                <div class="input-group">
                    <input type="text" id="newGroupNameFromChat" placeholder="T√™n nh√≥m..." />
                </div>
                <div style="font-size:0.9rem; margin-bottom:5px; font-weight:500;">Ch·ªçn th√†nh vi√™n:</div>
                <div id="selectFriendsList"></div>
                <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">
                    * C·∫ßn t·ªëi thi·ªÉu 3 th√†nh vi√™n (bao g·ªìm b·∫°n).
                </div>
                <div class="modal-actions">
                    <button onclick="document.getElementById('createGroupModal').classList.add('hidden')">H·ªßy</button>
                    <button onclick="submitCreateGroupFromChat()">T·∫°o nh√≥m</button>
                </div>
            </div>
        </div>

        <div id="toast">Th√¥ng b√°o</div>

        <script>
            // --- C·∫§U H√åNH SERVER ---
            const SERVER_URL = "https://nhom11-ungdungchatreal-time.onrender.com/";
            let socket = null;

            let myName = "";
            let currentTarget = null;
            let myGroups = new Set();
            let myFriends = new Set();
            let mySentRequests = new Set();
            let myReceivedRequests = new Set();
            let unreadCounts = {};
            let lastUsersList = [];
            let typingTimeout = null;
            const CHUNK_SIZE = 4096;

            // --- Init Listeners ---
            window.addEventListener('DOMContentLoaded', function () {
                // File Input
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', async function (e) {
                        const file = e.target.files[0];
                        if (!file || !socket || !socket.connected) return;
                        sendJson('FILE_REQUEST', {
                            filename: file.name,
                            filesize: file.size,
                            receiver: null
                        });
                        let chunkNum = 0;
                        const reader = new FileReader();
                        let offset = 0;
                        function sendChunk() {
                            const slice = file.slice(offset, offset + CHUNK_SIZE);
                            reader.readAsArrayBuffer(slice);
                        }
                        reader.onload = function (ev) {
                            const chunk = new Uint8Array(ev.target.result);
                            const chunk_b64 = btoa(String.fromCharCode.apply(null, chunk));
                            sendJson('FILE_CHUNK', {
                                chunk_num: chunkNum,
                                data: chunk_b64
                            });
                            offset += CHUNK_SIZE;
                            chunkNum++;
                            if (offset < file.size) {
                                sendChunk();
                            } else {
                                sendJson('FILE_END', {});
                                showToast('ƒê√£ g·ª≠i file: ' + file.name);
                            }
                        };
                        sendChunk();
                    });
                }

                // Chat Input (Typing + Enter)
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.onkeypress = (e) => {
                        if (e.key === 'Enter') sendMessage();
                    };
                    chatInput.addEventListener('input', function () {
                        if (typingTimeout) clearTimeout(typingTimeout);
                        if (!currentTarget) return;

                        let targetVal = null;
                        let mode = null;

                        if (currentTarget.startsWith('User:')) {
                            mode = 'private';
                            targetVal = currentTarget.split(':')[1];
                        } else if (currentTarget.startsWith('Group:')) {
                            mode = 'group';
                            targetVal = parseInt(currentTarget.split(':')[1]);
                        }

                        if (mode && targetVal) {
                            sendJson('TYPING', { mode: mode, target: targetVal });
                        }

                        typingTimeout = setTimeout(() => {
                            stopTypingEvent();
                        }, 2000);
                    });
                }

                // Auto Login Check
                const savedUser = localStorage.getItem('chat_username');
                const savedPass = localStorage.getItem('chat_password');
                if (savedUser) document.getElementById('loginUser').value = savedUser;
                if (savedPass) document.getElementById('loginPass').value = savedPass;
                if (savedUser && savedPass) handleAuth('LOGIN', true);
            });

            // --- Auth UI Logic ---
            function switchAuth(mode) {
                const loginForm = document.getElementById('loginForm');
                const regForm = document.getElementById('registerForm');
                const tabLogin = document.getElementById('tabLogin');
                const tabReg = document.getElementById('tabRegister');
                const title = document.querySelector('.auth-title');

                if (mode === 'login') {
                    loginForm.classList.remove('hidden');
                    regForm.classList.add('hidden');
                    tabLogin.classList.add('active');
                    tabReg.classList.remove('active');
                    title.textContent = "Ch√†o m·ª´ng tr·ªü l·∫°i";
                } else {
                    loginForm.classList.add('hidden');
                    regForm.classList.remove('hidden');
                    tabLogin.classList.remove('active');
                    tabReg.classList.add('active');
                    title.textContent = "T·∫°o t√†i kho·∫£n m·ªõi";
                }
                document.getElementById('authError').textContent = "";
            }

            function handleEnter(e, type) {
                if (e.key === 'Enter') handleAuth(type);
            }

            function showToast(msg) {
                const el = document.getElementById('toast');
                el.textContent = msg;
                el.className = "show";
                setTimeout(() => { el.className = el.className.replace("show", ""); }, 3000);
            }

            // --- Socket.IO & Auth Logic ---
            function handleAuth(type, autoLogin = false) {
                const userIn = type === 'LOGIN' ? document.getElementById('loginUser') : document.getElementById('regUser');
                const passIn = type === 'LOGIN' ? document.getElementById('loginPass') : document.getElementById('regPass');
                const username = userIn.value.trim();
                const password = passIn.value.trim();

                if (type === 'REGISTER') {
                    const conf = document.getElementById('regConfirm').value.trim();
                    if (password !== conf) {
                        document.getElementById('authError').textContent = "M·∫≠t kh·∫©u kh√¥ng kh·ªõp!";
                        return;
                    }
                }

                if (!username || !password) {
                    if (!autoLogin) document.getElementById('authError').textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!";
                    return;
                }

                if (!socket || socket.disconnected) {
                    socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });
                    socket.on('connect', () => {
                        sendJson(type, { username, password });
                        myName = username;
                    });
                    socket.on('disconnect', () => {
                        if (document.getElementById('chatPanel').style.display === 'flex') {
                            showToast("ƒê√£ m·∫•t k·∫øt n·ªëi v·ªõi Server");
                            setTimeout(() => location.reload(), 2000);
                        }
                    });
                    socket.on('message', (data) => handleServerMessage(data));

                    if (socket.connected) {
                        sendJson(type, { username, password });
                        myName = username;
                    }
                } else {
                    sendJson(type, { username, password });
                    myName = username;
                }
            }

            function sendJson(type, payload) {
                if (socket) socket.emit('message', { type, payload });
            }

            function handleServerMessage(data) {
                if (typeof data === 'string') { try { data = JSON.parse(data); } catch (e) { } }
                console.log("Recv:", data);

                switch (data.type) {
                    case 'LOGIN_SUCCESS':
                        if (myName) {
                            const pass = document.getElementById('loginPass').value || '';
                            localStorage.setItem('chat_username', myName);
                            localStorage.setItem('chat_password', pass);
                        }
                        enterChatMode();
                        break;
                    case 'ERROR':
                        document.getElementById('authError').textContent = data.payload;
                        showToast(data.payload);
                        break;
                    case 'SUCCESS':
                        showToast(data.payload);
                        if (data.payload.includes('Friend request sent') || data.payload.includes('now friends')) {
                            sendJson('FRIEND_LIST', null);
                        }
                        break;
                    case 'TEXT':
                        // Public chat not used in this UI version mostly
                        break;
                    case 'PRIVATE':
                        const p = data.payload;
                        const partner = (p.sender === myName) ? p.receiver : p.sender;
                        // Fix: Ensure we correctly identify the user when we are sending to them vs receiving
                        // Actually, for unread logic, we only care if WE received it from someone else

                        if (currentTarget === `User:${partner}`) {
                            const msgType = (p.sender === myName) ? 'sent' : 'received';
                            appendMessage(p.content, msgType, p.sender);
                        } else if (p.sender !== myName) {
                            // Received message but not in chat -> Add unread
                            const key = `User:${p.sender}`;
                            unreadCounts[key] = (unreadCounts[key] || 0) + 1;
                            updateUnreadUI(key);
                            showToast(`Tin nh·∫Øn m·ªõi t·ª´ ${p.sender}`);
                            playSound();
                        }
                        break;
                    case 'GROUP':
                        const gKey = `Group:${data.payload.group_id}`;
                        if (currentTarget === gKey) {
                            const msgType = (data.payload.sender === myName) ? 'sent' : 'received';
                            appendMessage(data.payload.content, msgType, data.payload.sender);
                            if (data.payload.sender !== myName) playSound();
                        } else if (myGroups.has(data.payload.group_id) && data.payload.sender !== myName) {
                            unreadCounts[gKey] = (unreadCounts[gKey] || 0) + 1;
                            updateUnreadUI(gKey);
                            playSound();
                        }
                        break;
                    case 'USER_GROUPS':
                        myGroups.clear();
                        data.payload.forEach(gid => myGroups.add(gid));
                        // Request fresh list to update buttons
                        sendJson('GROUPS_REQUEST', null);
                        break;
                    case 'FILE':
                        const file = data.payload;
                        const fileUrl = `${SERVER_URL}/download?filename=${encodeURIComponent(file.filename)}`;
                        let fileMsg = "";
                        const ext = file.filename.split('.').pop().toLowerCase();

                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                            fileMsg = `<div style="font-weight:600;margin-bottom:4px">üìé ${file.filename}</div><img src="${fileUrl}" class="media-preview" onclick="window.open('${fileUrl}', '_blank')">`;
                        } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
                            fileMsg = `<div style="font-weight:600;margin-bottom:4px">üìé ${file.filename}</div><video src="${fileUrl}" controls class="media-preview" style="max-height: 200px"></video>`;
                        } else {
                            fileMsg = `<a href="${fileUrl}" target="_blank" style="color:#6366f1;font-weight:600;text-decoration:underline">üìé ${file.filename}</a> (${(file.filesize / 1024).toFixed(1)} KB)`;
                        }

                        const isMe = (file.sender === myName);
                        // Hi·ªÉn th·ªã n·∫øu ƒëang ·ªü ƒë√∫ng khung chat
                        // C·∫ßn logic server tr·∫£ v·ªÅ receiver/group_id ƒë·ªÉ check, ·ªü ƒë√¢y gi·∫£ ƒë·ªãnh server broadcast ƒë√∫ng
                        // Simplified: just append if it looks like current context or just ignore context check for now
                        appendMessage(fileMsg, isMe ? 'sent' : 'received', file.sender || 'File');
                        if (!isMe) playSound();
                        break;
                    case 'TYPING':
                        handleTyping(data.payload, true);
                        break;
                    case 'STOP_TYPING':
                        handleTyping(data.payload, false);
                        break;
                    case 'UPDATE_NAME_SUCCESS':
                        const newName = data.payload;
                        document.getElementById('myNameDisplay').textContent = newName;
                        showToast('ƒê√£ ƒë·ªïi t√™n th√†nh c√¥ng: ' + newName);
                        break;
                    case 'USERS_LIST':
                        renderUsers(data.payload);
                        break;
                    case 'GROUPS_LIST':
                        renderGroups(data.payload);
                        break;
                    case 'FRIEND_LIST':
                        renderFriendsList(data.payload);
                        break;
                    case 'FRIEND_REQUEST':
                        const reqUser = data.payload.requester;
                        showToast(`L·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ${reqUser}`);
                        // Refresh lists (trigger re-fetch)
                        sendJson('FRIEND_LIST', null);
                        break;
                    case 'FRIEND_ACCEPT':
                        showToast(`${data.payload.accepter} ƒë√£ ƒë·ªìng √Ω k·∫øt b·∫°n!`);
                        sendJson('FRIEND_LIST', null);
                        break;
                    case 'USER_STATUS':
                        // Update specific user status in friend list UI
                        updateFriendStatus(data.payload);
                        break;
                    case 'GROUP_MEMBERS_RESPONSE':
                        renderGroupMembers(data.payload);
                        break;
                }
            }

            function playSound() {
                const audio = document.getElementById('notifySound');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => { });
                }
            }

            function handleTyping(payload, isTyping) {
                const indicator = document.getElementById('typingIndicator');
                let show = false;

                if (payload.mode === 'private') {
                    if (currentTarget === `User:${payload.sender}`) show = true;
                } else if (payload.mode === 'group') {
                    if (currentTarget === `Group:${payload.group_id}` && payload.sender !== myName) show = true;
                }

                if (show && isTyping) {
                    indicator.textContent = `${payload.sender} ƒëang nh·∫≠p...`;
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }

            function promptChangeName() {
                const newName = prompt("Nh·∫≠p t√™n hi·ªÉn th·ªã m·ªõi:");
                if (newName && newName.trim()) {
                    sendJson('UPDATE_NAME', { new_name: newName.trim() });
                }
            }

            function updateUnreadUI(key) {
                // Find element
                const el = document.querySelector(`.list-item[data-key="${key}"]`);
                if (!el) return;

                const info = el.querySelector('.item-info');
                if (!info) return;

                let badge = info.querySelector('.unread-badge');
                const count = unreadCounts[key] || 0;

                if (count > 0) {
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        info.appendChild(badge);
                    }
                    badge.textContent = count > 99 ? '99+' : count;
                } else {
                    if (badge) badge.remove();
                }
            }

            function stopTypingEvent() {
                if (!currentTarget) return;
                if (currentTarget.startsWith('User:')) {
                    const target = currentTarget.split(':')[1];
                    sendJson('STOP_TYPING', { mode: 'private', target: target });
                } else if (currentTarget.startsWith('Group:')) {
                    const target = parseInt(currentTarget.split(':')[1]);
                    sendJson('STOP_TYPING', { mode: 'group', target: target });
                }
            }

            function enterChatMode() {
                document.getElementById('authPanel').style.display = 'none';
                document.getElementById('chatPanel').style.display = 'flex'; // Chat panel l√† flex
                document.getElementById('myNameDisplay').textContent = myName;
                document.getElementById('myAvatar').textContent = myName.charAt(0).toUpperCase();

                // Reset Chat View
                document.getElementById('chatMainContent').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'flex';
            }

            // --- Render Lists ---
            // --- Render Lists ---
            function switchSidebar(view) {
                const chats = document.getElementById('viewChats');
                const discover = document.getElementById('viewDiscover');
                const tChats = document.getElementById('tabChats');
                const tDiscover = document.getElementById('tabDiscover');

                if (view === 'chats') {
                    chats.classList.remove('hidden');
                    discover.classList.add('hidden');
                    tChats.classList.add('active');
                    tDiscover.classList.remove('active');
                } else {
                    chats.classList.add('hidden');
                    discover.classList.remove('hidden');
                    tChats.classList.remove('active');
                    tDiscover.classList.add('active');
                }
            }

            function renderFriendsList(payload) {
                const friends = payload.friends; // list of {username, display_name, last_login, status}
                const pending = payload.pending; // list of {username, display_name}
                const sent = payload.sent || []; // list: {username}
                const container = document.getElementById('friendsList');
                container.innerHTML = '';

                myFriends.clear();
                myReceivedRequests.clear();
                mySentRequests.clear();

                friends.forEach(f => myFriends.add(f.username));
                pending.forEach(p => myReceivedRequests.add(p.username));
                sent.forEach(s => mySentRequests.add(s.username));

                friends.forEach(f => {
                    const isActive = currentTarget === `User:${f.username}`;
                    const key = `User:${f.username}`;
                    const unread = unreadCounts[key] || 0;

                    const div = document.createElement('div');
                    div.className = `list-item ${isActive ? 'active' : ''}`;
                    div.setAttribute('data-key', key);

                    // Status text
                    let statusText = "Offline";
                    let statusColor = "#94a3b8"; // Gray
                    if (f.status === 'online') {
                        statusText = "Online";
                        statusColor = "#4ade80"; // Green
                    } else if (f.last_login) {
                        // Parse time string
                        const last = new Date(f.last_login);
                        const now = new Date();
                        const diffMs = now - last;
                        const diffMins = Math.floor(diffMs / 60000);

                        if (diffMins < 1) statusText = "Offline v·ª´a xong";
                        else if (diffMins < 60) statusText = `Offline ${diffMins} ph√∫t tr∆∞·ªõc`;
                        else {
                            const hours = Math.floor(diffMins / 60);
                            if (hours < 24) statusText = `Offline ${hours} gi·ªù tr∆∞·ªõc`;
                            else statusText = `Offline ${Math.floor(hours / 24)} ng√†y tr∆∞·ªõc`;
                        }
                    }

                    div.innerHTML = `
                    <div class="item-info">
                        <div class="avatar" style="width: 32px; height: 32px; font-size: 0.8rem; background: #e2e8f0; color: #64748b;">${f.display_name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div>${f.display_name}</div>
                            <div class="status-text" style="font-size:0.7rem; color:${statusColor}; font-weight:500;">${statusText}</div>
                        </div>
                        ${unread > 0 ? `<div class="unread-badge">${unread > 99 ? '99+' : unread}</div>` : ''}
                    </div>
                `;
                    div.onclick = () => setTarget('User', f.username, f.display_name);
                    container.appendChild(div);
                });

                // Pending
                const pendingSec = document.getElementById('pendingSection');
                const pendingList = document.getElementById('pendingList');
                if (pending.length > 0) {
                    pendingSec.classList.remove('hidden');
                    pendingList.innerHTML = '';
                    pending.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.style.cursor = 'default';
                        div.innerHTML = `
                        <div class="item-info">
                            <span>${p.display_name}</span>
                        </div>
                        <div class="item-actions">
                             <button class="action-btn" style="background:var(--primary);color:white" onclick="acceptFriend('${p.username}')">ƒê·ªìng √Ω</button>
                        </div>
                    `;
                        pendingList.appendChild(div);
                    });
                } else {
                    pendingSec.classList.add('hidden');
                }

                if (lastUsersList.length > 0) {
                    renderUsers(lastUsersList);
                }
            }

            function requestFriend(target) {
                sendJson('FRIEND_REQUEST', { target: target });
            }

            function acceptFriend(requester) {
                sendJson('FRIEND_ACCEPT', { requester: requester });
            }

            function updateFriendStatus(payload) {
                sendJson('FRIEND_LIST', null);
            }

            function renderUsers(users) {
                lastUsersList = users; // Cache it
                const container = document.getElementById('usersList');
                container.innerHTML = '';
                users.forEach(u => {
                    const username = typeof u === 'string' ? u : u.username;
                    const displayName = typeof u === 'string' ? u : u.display_name;

                    if (username === myName) return;

                    const isFriend = myFriends.has(username);
                    const isSent = mySentRequests.has(username);
                    const isReceived = myReceivedRequests.has(username);

                    const div = document.createElement('div');
                    div.className = `list-item`;

                    let actions = '';
                    if (isFriend) {
                        actions = `<span style="font-size:0.75rem;color:var(--success);">B·∫°n b√®</span>`;
                    } else if (isReceived) {
                        actions = `<button class="action-btn" style="background:var(--primary);color:white" onclick="acceptFriend('${username}')">Ch·∫•p nh·∫≠n</button>`;
                    } else if (isSent) {
                        actions = `<span style="font-size:0.75rem;color:#64748b;">ƒê√£ g·ª≠i l·ªùi m·ªùi</span>`;
                    } else {
                        actions = `<button class="action-btn btn-join" onclick="requestFriend('${username}')">K·∫øt b·∫°n</button>`;
                    }

                    div.innerHTML = `
                    <div class="item-info">
                        <div class="avatar" style="width: 32px; height: 32px; font-size: 0.8rem; background: #e2e8f0; color: #64748b;">${(displayName || username).charAt(0).toUpperCase()}</div>
                        <span>${displayName || username}</span>
                    </div>
                    ${actions}
                `;

                    if (isFriend) {
                        div.onclick = () => {
                            switchSidebar('chats');
                            setTarget('User', username, displayName || username);
                        };
                    }

                    container.appendChild(div);
                });
            }

            function renderGroups(groups) {
                const joinedContainer = document.getElementById('groupsList');
                const connectContainer = document.getElementById('groupsConnectList');

                if (joinedContainer) joinedContainer.innerHTML = '';
                if (connectContainer) connectContainer.innerHTML = '';

                // Deduplicate groups by ID
                const uniqueGroups = [];
                const seenIds = new Set();
                groups.forEach(g => {
                    if (!seenIds.has(g.id)) {
                        seenIds.add(g.id);
                        uniqueGroups.push(g);
                    }
                });

                // Hi·ªÉn th·ªã nh√≥m ƒë√£ tham gia/t·∫°o ·ªü tab c·ªßa t√¥i, nh√≥m ch∆∞a tham gia ·ªü tab kh√°m ph√°
                uniqueGroups.forEach(g => {
                    const isMember = myGroups.has(g.id);
                    const isActive = currentTarget === `Group:${g.id}`;
                    const isCreator = g.creator === myName;
                    const key = `Group:${g.id}`;
                    const unread = unreadCounts[key] || 0;

                    let actions = '';
                    if (isMember) {
                        actions += `<button class="action-btn btn-leave" onclick="leaveGroup(${g.id})">R·ªùi nh√≥m</button>`;
                        if (isCreator) {
                            actions += `<button class="action-btn" style="background:rgba(239,68,68,0.1);color:var(--danger);" onclick="deleteGroup(${g.id}, '${g.name}')">X√≥a</button>`;
                        }
                        // Tab c·ªßa t√¥i
                        const div = document.createElement('div');
                        div.className = `list-item${isActive ? ' active' : ''}`;
                        div.setAttribute('data-key', key);
                        div.innerHTML = `
                            <div class="item-info" onclick="setTarget('Group', '${g.id}', '${g.name}')">
                                <div class="avatar" style="width: 32px; height: 32px; font-size: 0.8rem; background: var(--secondary);">
                                    <i class="fa-solid fa-users"></i>
                                </div>
                                <span>${g.name}</span>
                                ${unread > 0 ? `<div class="unread-badge">${unread > 99 ? '99+' : unread}</div>` : ''}
                            </div>
                            <div class="item-actions">${actions}</div>
                        `;
                        if (joinedContainer) joinedContainer.appendChild(div);
                    } else {
                        actions += `<button class="action-btn btn-join" onclick="joinGroup(${g.id}, '${g.name}')">Tham gia</button>`;
                        // Tab kh√°m ph√°
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.setAttribute('data-key', key);
                        div.innerHTML = `
                            <div class="item-info">
                                <div class="avatar" style="width: 32px; height: 32px; font-size: 0.8rem; background: var(--secondary);">
                                    <i class="fa-solid fa-users"></i>
                                </div>
                                <span>${g.name}</span>
                            </div>
                            <div class="item-actions">${actions}</div>
                        `;
                        if (connectContainer) connectContainer.appendChild(div);
                    }
                });
            }

            function renderGroupMembers(payload) {
                console.log("[DEBUG] Received group members payload:", payload);
                if (!currentTarget || !currentTarget.startsWith('Group:')) {
                    console.log("[DEBUG] Current target is not a group or null:", currentTarget);
                    return;
                }

                const currentGid = currentTarget.split(':')[1];
                // Convert both to strings for robust comparison
                if (String(currentGid) !== String(payload.group_id)) {
                    console.log("[DEBUG] Mismatch group ID. Current:", currentGid, "Payload:", payload.group_id);
                    return;
                }

                const list = document.getElementById('groupMembersList');
                list.innerHTML = '';

                if (!payload.members || payload.members.length === 0) {
                    list.innerHTML = '<div style="padding:10px; color:#64748b; font-size:0.9rem;">Ch∆∞a c√≥ th√†nh vi√™n n√†o.</div>';
                    console.log("[DEBUG] No members found for group", payload.group_id);
                    return;
                }

                console.log("[DEBUG] Rendering", payload.members.length, "members");
                payload.members.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'member-item';
                    div.innerHTML = `
                    <div class="avatar" style="background:#e2e8f0; color:#64748b;">${m.display_name.charAt(0).toUpperCase()}</div>
                    <div class="member-name" style="flex:1;">${m.display_name}</div>
                    <div class="member-status ${m.status}" title="${m.status}"></div>
                `;
                    list.appendChild(div);
                });
            }

            function createNewGroup() {
                const name = prompt("Nh·∫≠p t√™n nh√≥m m·ªõi:");
                if (name) {
                    sendJson('GROUP_CREATE', name);
                    // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t l·∫°i danh s√°ch nh√≥m
                    sendJson('GROUPS_REQUEST', null);
                }
            }

            function openCreateGroupModal() {
                if (!currentTarget || !currentTarget.startsWith('User:')) return;

                const currentFriend = currentTarget.split(':')[1];
                const modal = document.getElementById('createGroupModal');
                const list = document.getElementById('selectFriendsList');
                const nameInput = document.getElementById('newGroupNameFromChat');

                nameInput.value = '';
                list.innerHTML = '';

                myFriends.forEach(f => {
                    const isCurrent = (f === currentFriend);
                    const div = document.createElement('div');
                    div.className = 'friend-select-item';
                    div.innerHTML = `
                    <input type="checkbox" value="${f}" ${isCurrent ? 'checked disabled' : ''}>
                    <span>${f}</span>
                `;
                    list.appendChild(div);
                });

                modal.classList.remove('hidden');
            }

            function submitCreateGroupFromChat() {
                const name = document.getElementById('newGroupNameFromChat').value.trim();
                if (!name) {
                    alert("Vui l√≤ng nh·∫≠p t√™n nh√≥m");
                    return;
                }

                const checkboxes = document.querySelectorAll('#selectFriendsList input[type="checkbox"]:checked');
                const members = Array.from(checkboxes).map(cb => cb.value);

                // Validate client side (optional but good UI) - include self in count thinking
                // Members list contains friends. Me is implicit.
                // Client checks: Me + Selected Friends >= 3
                if (members.length + 1 < 3) {
                    alert("Nh√≥m ph·∫£i c√≥ √≠t nh·∫•t 3 th√†nh vi√™n (bao g·ªìm b·∫°n).");
                    return;
                }

                sendJson('GROUP_CREATE', { name: name, members: members });
                document.getElementById('createGroupModal').classList.add('hidden');
            }

            function deleteGroup(gid, gname) {
                if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m '${gname}'?`)) return;
                sendJson('GROUP_DELETE', { group_id: gid });
            }

            function joinGroup(gid, gname) {
                sendJson('GROUP_JOIN', gid);
                // Optimistic update
                myGroups.add(gid);
                showToast(`ƒê√£ tham gia nh√≥m ${gname}`);

                // Switch sidebar to chats view
                switchSidebar('chats');

                setTarget('Group', gid, gname);
                // Re-render to update buttons
                sendJson('GROUPS_REQUEST', null);
            }

            function leaveGroup(gid) {
                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi nh√≥m?")) return;
                sendJson('GROUP_LEAVE', gid);

                // Optimistic update
                myGroups.delete(gid);

                if (currentTarget === `Group:${gid}`) {
                    currentTarget = null;
                    document.getElementById('chatMainContent').style.display = 'none';
                    document.getElementById('welcomeScreen').style.display = 'flex';
                }
                showToast("ƒê√£ r·ªùi nh√≥m");
                // Re-render to update buttons
                sendJson('GROUPS_REQUEST', null);
            }

            // --- Chat Navigation ---
            function setTarget(type, id, name) {
                currentTarget = `${type}:${id}`;

                // Buttons logic
                const btnCreate = document.getElementById('btnCreateGroupFromChat');
                const btnInfo = document.getElementById('btnToggleInfo');

                if (type === 'Group') {
                    btnCreate.classList.add('hidden');
                    btnInfo.classList.remove('hidden');
                    // We do NOT fetch members immediately to save resources/UI sync
                    // Or we can fetch effectively but invisible
                    // sendJson('GROUP_MEMBERS', { group_id: id }); // Fetch only when sidebar is active
                } else {
                    btnCreate.classList.remove('hidden');
                    btnInfo.classList.add('hidden');
                }

                // Hide sidebar by default to avoid layout break
                const sidebar = document.getElementById('chatInfoSidebar');
                sidebar.classList.remove('active');

                // Reset Accordion and Members List
                const accContent = document.getElementById('membersAccordion');
                if (accContent) {
                    accContent.classList.remove('open');
                    const accHeader = accContent.previousElementSibling;
                    if (accHeader) accHeader.classList.remove('active');
                    document.getElementById('groupMembersList').innerHTML = '';
                }

                // Clear unread
                unreadCounts[currentTarget] = 0;
                updateUnreadUI(currentTarget);

                // Switch view
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('chatMainContent').style.display = 'flex'; // Must be flex

                // Update Header
                const targetNameEl = document.getElementById('targetName');
                const targetStatusEl = document.getElementById('targetStatus');
                const targetAvatarEl = document.getElementById('targetAvatar');

                targetNameEl.textContent = name;
                document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));

                if (type === 'User') {
                    targetStatusEl.textContent = "Tin nh·∫Øn ri√™ng t∆∞";
                    // Check status if friend
                    // Find friend status
                    const friendEl = document.querySelector(`.list-item[data-key="User:${id}"] .status-text`);
                    if (friendEl) {
                        targetStatusEl.textContent = friendEl.textContent;
                    }

                    targetAvatarEl.innerHTML = name.charAt(0).toUpperCase();
                    targetAvatarEl.style.background = '#e2e8f0';
                    targetAvatarEl.style.color = '#64748b';

                } else if (type === 'Group') {
                    targetStatusEl.textContent = `Nh√≥m ID: ${id}`;
                    targetAvatarEl.innerHTML = '<i class="fa-solid fa-users"></i>';
                    targetAvatarEl.style.background = 'var(--secondary)';
                    targetAvatarEl.style.color = 'white';
                    document.getElementById('btnCreateGroupFromChat').classList.add('hidden');
                }

                document.getElementById('messages').innerHTML = '';

                // Fetch History
                if (type === 'User') sendJson('HISTORY_REQUEST', { history_type: 'private', target: id });
                else if (type === 'Group') sendJson('HISTORY_REQUEST', { history_type: 'group', target: id });

                appendMessage(`--- B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi ${name} ---`, 'system');

                if (window.innerWidth <= 768) {
                    document.getElementById('chatPanel').classList.add('mobile-show-chat');
                }
            }

            function toggleAccordion(id, header) {
                const content = document.getElementById(id);
                if (content) {
                    const isOpen = content.classList.contains('open');
                    if (isOpen) {
                        content.classList.remove('open');
                        header.classList.remove('active');
                    } else {
                        content.classList.add('open');
                        header.classList.add('active');

                        if (id === 'membersAccordion') {
                            if (currentTarget && currentTarget.startsWith('Group:')) {
                                document.getElementById('groupMembersList').innerHTML = '<div style="padding:10px;font-size:0.8rem;color:#64748b;">ƒêang t·∫£i...</div>';
                                const gid = currentTarget.split(':')[1];
                                sendJson('GROUP_MEMBERS', { group_id: gid });
                            }
                        }
                    }
                }
            }

            function toggleChatInfo() {
                const sidebar = document.getElementById('chatInfoSidebar');
                sidebar.classList.toggle('active');
                // Re-fetch members if opening
                if (sidebar.classList.contains('active')) {
                    // By default open the members accordion? Or keep it closed?
                    // Let's keep it closed or user opens it.
                    // Or auto open? Let's auto open for convenience
                    const accContent = document.getElementById('membersAccordion');
                    const accHeader = accContent.previousElementSibling;
                    if (!accContent.classList.contains('open')) {
                        toggleAccordion('membersAccordion', accHeader);
                    }
                }
            }

            function backToSidebar() {
                document.getElementById('chatPanel').classList.remove('mobile-show-chat');
            }

            function logout() {
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
                    localStorage.removeItem('chat_username');
                    localStorage.removeItem('chat_password');
                    location.reload();
                }
            }

            function sendMessage() {
                const input = document.getElementById('chatInput');
                const txt = input.value.trim();
                if (!txt || !currentTarget) return;

                if (currentTarget.startsWith('User:')) {
                    const targetUser = currentTarget.split(':')[1];
                    sendJson('PRIVATE', { receiver: targetUser, content: txt });
                    appendMessage(txt, 'sent');
                } else if (currentTarget.startsWith('Group:')) {
                    const groupId = parseInt(currentTarget.split(':')[1]);
                    sendJson('GROUP', { group_id: groupId, content: txt });
                    appendMessage(txt, 'sent');
                }
                input.value = '';
                stopTypingEvent();
            }

            function appendMessage(content, type = 'received', sender = '') {
                const container = document.getElementById('messages');
                let displayContent = content;
                let displaySender = sender;

                const div = document.createElement('div');
                div.className = `message ${type}`;

                let html = '';
                if (displaySender && type !== 'sent' && type !== 'system') {
                    html += `<div class="msg-sender">${displaySender}</div>`;
                }
                html += `<div>${displayContent}</div>`;

                div.innerHTML = html;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }

            // --- Emoji Logic ---
            const emojis = ["üòÄ", "üòÇ", "ü•∞", "üòç", "üòé", "üò≠", "üò°", "üëç", "üëé", "üéâ", "‚ù§Ô∏è", "üíî", "üî•", "‚ú®", "üéÅ", "üëã", "üôè", "ü§ù", "üëÄ", "üíØ", "‚úÖ", "‚ùå", "‚ùì"];
            function toggleEmojiPicker() {
                const picker = document.getElementById('emojiPicker');
                picker.classList.toggle('hidden');
            }
            function insertEmoji(emoji) {
                const input = document.getElementById('chatInput');
                input.value += emoji;
                input.focus();
            }
            document.addEventListener('click', function (e) {
                const picker = document.getElementById('emojiPicker');
                const btn = document.getElementById('emojiBtn');
                if (picker && !picker.classList.contains('hidden') && !picker.contains(e.target) && !btn.contains(e.target)) {
                    picker.classList.add('hidden');
                }
            });
            const pickerContainer = document.getElementById('emojiPicker');
            if (pickerContainer) {
                emojis.forEach(emo => {
                    const span = document.createElement('span');
                    span.textContent = emo;
                    span.onclick = () => insertEmoji(emo);
                    pickerContainer.appendChild(span);
                });
            }
        </script>
</body>

</html>